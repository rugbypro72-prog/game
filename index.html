<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Chatt v1.0</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root { --bg:#03050a; --me:#1e293b; --you:#0f172a; }
body {
  background:var(--bg);
  color:#f1f5f9;
  margin:0;
  height:100vh;
  overflow:hidden;
  -webkit-tap-highlight-color: transparent;
}
#chat {
  max-width:640px;
  margin:auto;
  height:100%;
  display:flex;
  flex-direction:column;
}
#messages {
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.bubble {
  max-width:85%;
  padding:12px 14px 26px;
  border-radius:18px;
  position:relative;
  word-wrap:break-word;
}
.me { background:var(--me); align-self:flex-end; }
.you { background:var(--you); align-self:flex-start; }
.ts {
  position:absolute;
  bottom:6px;
  right:10px;
  font-size:9px;
  opacity:.5;
}
header {
  padding:12px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  text-align:center;
  font-weight:600;
}
footer {
  padding:12px;
  border-top:1px solid rgba(255,255,255,.08);
}
input {
  font-size:16px; /* prevents iOS zoom */
}
</style>
</head>

<body>
<div id="chat">
  <header id="header">Chatt v1.0</header>

  <main id="messages"></main>

  <footer>
    <form id="form" class="flex gap-2">
      <input
        id="input"
        class="flex-1 bg-black/40 rounded-full px-4 py-3 outline-none"
        placeholder="Message…"
        autocomplete="off"
      >
      <button
        type="submit"
        class="bg-blue-600 px-5 rounded-full font-semibold"
      >
        Send
      </button>
    </form>
  </footer>
</div>

<script>
(async function () {

const SUPABASE_URL = "https://zsuvmrlgwjsjkzfbfljq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzdXZtcmxnd2pzamt6ZmJmbGpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDAwMTEsImV4cCI6MjA4Mzk3NjAxMX0.iBuU3DIfVx_dLGoWvZdwHMTA0bHgbd29Kxn2Dkec08A";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let me, you;

/* ---------- AUTH ---------- */
async function auth() {
  let code = localStorage.getItem("access_code");
  if (!code) {
    code = prompt("Enter access code:");
    if (!code) return;
    localStorage.setItem("access_code", code);
  }

  const { data, error } = await db
    .from("chat_users")
    .select("*")
    .eq("access_code", code)
    .single();

  if (error || !data) {
    localStorage.removeItem("access_code");
    location.reload();
    return;
  }

  me = data.username;
  you = me === "RJ" ? "Alyvia" : "RJ";

  document.getElementById("header").textContent = you;
  document.title = `Chatt v1.0 — ${you}`;
}

/* ---------- LOAD ---------- */
async function loadMessages() {
  const { data } = await db
    .from("private_messages")
    .select("*")
    .order("created_at");

  const wrap = document.getElementById("messages");
  wrap.innerHTML = "";

  data.forEach(m => {
    const div = document.createElement("div");
    div.className = `bubble ${m.sender === me ? "me" : "you"}`;

    div.innerHTML = m.is_deleted
      ? "<i class='opacity-60'>Message deleted</i>"
      : m.message;

    const ts = document.createElement("div");
    ts.className = "ts";
    ts.textContent = new Date(m.created_at)
      .toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    div.appendChild(ts);

    wrap.appendChild(div);
  });

  wrap.scrollTop = wrap.scrollHeight;
}

/* ---------- REALTIME ---------- */
db.channel("chatt-v1")
  .on("postgres_changes", {
    event: "*",
    schema: "public",
    table: "private_messages"
  }, loadMessages)
  .subscribe();

/* ---------- SEND ---------- */
async function sendMessage(text) {
  await db.from("private_messages").insert({
    sender: me,
    receiver: you,
    message: text
  });
}

/* ---------- FORM ---------- */
document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  input.value = "";
  await sendMessage(text);
});

/* ---------- BOOT ---------- */
await auth();
await loadMessages();

})();
</script>
</body>
</html>
