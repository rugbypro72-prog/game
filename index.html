<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>RJ & Alyvia</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root { --bg:#03050a; --me:#1e293b; --you:#0f172a; }
body { background:var(--bg); color:#f1f5f9; height:100vh; margin:0; overflow:hidden; }
#chat { max-width:600px; margin:auto; height:100%; display:flex; flex-direction:column; }
#messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
.bubble { max-width:85%; padding:12px 14px 24px; border-radius:20px; position:relative; }
.me { background:var(--me); align-self:flex-end; }
.you { background:var(--you); align-self:flex-start; }
.ts { position:absolute; bottom:6px; right:10px; font-size:9px; opacity:.5; }
.tools { font-size:10px; opacity:.6; cursor:pointer; margin-top:4px; }
</style>
</head>

<body>
<div id="chat">
<header class="p-4 border-b border-white/10 font-bold text-center">
RJ & Alyvia
</header>

<main id="messages"></main>

<footer class="p-4">
<form id="form" class="flex gap-2">
<input id="input" class="flex-1 bg-black/40 rounded-full px-4 py-3 outline-none" placeholder="Message...">
<button class="bg-blue-600 px-6 rounded-full text-sm font-bold">Send</button>
</form>
</footer>
</div>

<script>
const SUPABASE_URL = 'https://zsuvmrlgwjsjkzfbfljq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzdXZtcmxnd2pzamt6ZmJmbGpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDAwMTEsImV4cCI6MjA4Mzk3NjAxMX0.iBuU3DIfVx_dLGoWvZdwHMTA0bHgbd29Kxn2Dkec08A';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let me = null;
let you = null;
let lastSend = 0;

/* ---------------- AUTH ---------------- */
async function initAuth() {
  let code = localStorage.getItem('access_code');
  if (!code) {
    code = prompt("Enter access code:");
    if (!code) return;
    localStorage.setItem('access_code', code);
  }

  const { data, error } = await db
    .from('chat_users')
    .select('*')
    .eq('access_code', code)
    .single();

  if (error || !data) {
    localStorage.removeItem('access_code');
    alert("Invalid code");
    location.reload();
    return;
  }

  me = data.username;
  you = me === 'RJ' ? 'Alyvia' : 'RJ';
}

initAuth().then(loadMessages);

/* ---------------- ERROR LOGGING ---------------- */
window.onerror = async (msg, src, line, col, err) => {
  await db.from('client_errors').insert({
    user_name: me,
    error: msg,
    stack: err?.stack || ''
  });
};

/* ---------------- MESSAGES ---------------- */
async function loadMessages() {
  const { data } = await db
    .from('private_messages')
    .select('*')
    .order('created_at');

  const wrap = document.getElementById('messages');
  wrap.innerHTML = '';

  data.forEach(m => {
    const isMe = m.sender === me;
    const div = document.createElement('div');
    div.className = `bubble ${isMe ? 'me' : 'you'}`;

    if (m.is_deleted) {
      div.innerHTML = `<i class="opacity-50">Message deleted</i>`;
    } else {
      div.textContent = m.message || '';
    }

    const ts = document.createElement('div');
    ts.className = 'ts';
    ts.textContent = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    div.appendChild(ts);

    if (isMe && !m.is_deleted) {
      const del = document.createElement('div');
      del.className = 'tools';
      del.textContent = 'Delete';
      del.onclick = () => deleteMsg(m);
      div.appendChild(del);
    }

    wrap.appendChild(div);
  });

  wrap.scrollTop = wrap.scrollHeight;
}

async function sendMsg(text) {
  const now = Date.now();
  if (now - lastSend < 600) return;
  lastSend = now;

  await db.from('private_messages').insert({
    sender: me,
    receiver: you,
    message: text
  });

  loadMessages();
}

async function deleteMsg(m) {
  await db.from('deleted_logs').insert({
    message_id: m.id,
    original_sender: m.sender,
    content: m.message,
    deleted_by: me
  });

  await db.from('private_messages')
    .update({ is_deleted: true })
    .eq('id', m.id);

  loadMessages();
}

/* ---------------- FORM ---------------- */
document.getElementById('form').onsubmit = e => {
  e.preventDefault();
  const input = document.getElementById('input');
  if (!input.value.trim()) return;
  sendMsg(input.value.trim());
  input.value = '';
};
</script>
</body>
</html>
